// Prisma Schema for NexusPoint Website
// Supports: PostgreSQL (recommended), MySQL, SQLite

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Contact form submissions
model Contact {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String   @db.Text
  status    ContactStatus @default(NEW)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

enum ContactStatus {
  NEW
  IN_PROGRESS
  RESOLVED
  ARCHIVED
}

// Newsletter subscribers
model Subscriber {
  id           String   @id @default(cuid())
  email        String   @unique
  isActive     Boolean  @default(true)
  subscribedAt DateTime @default(now())
  unsubscribedAt DateTime?

  @@index([email])
}

// Admin users for the backend
model Admin {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         AdminRole @default(ADMIN)
  isActive     Boolean  @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sessions     Session[]

  @@index([email])
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  VIEWER
}

// Admin sessions for authentication
model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  adminId   String
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  @@index([token])
  @@index([adminId])
}

// Demo/Consultation bookings
model Appointment {
  id          String   @id @default(cuid())
  name        String
  email       String
  phone       String
  service     String
  preferredDate DateTime
  preferredTime String
  message     String?  @db.Text
  status      AppointmentStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([preferredDate])
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

// Rate limiting records
model RateLimit {
  id         String   @id @default(cuid())
  identifier String   @unique // IP address or user ID
  endpoint   String
  count      Int      @default(0)
  windowStart DateTime @default(now())

  @@index([identifier, endpoint])
}

// Audit log for security
model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entityType String
  entityId  String?
  adminId   String?
  ipAddress String?
  userAgent String?
  details   Json?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([adminId])
  @@index([createdAt])
}

// -----------------------------
// POS SaaS (multi-tenant) models
// -----------------------------

model Tenant {
  id             String       @id @default(cuid())
  name           String
  slug           String       @unique
  country        String
  language       String
  companySize    CompanySize
  industry       TenantIndustry
  currency       String       @default("AED")
  timezone       String       @default("Asia/Dubai")
  theme          PosTheme     @default(EMERALD)

  ownerFirstName String
  ownerLastName  String
  ownerEmail     String
  ownerPhone     String?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  users              TenantUser[]
  productCategories  ProductCategory[]
  products           Product[]
  warehouses         Warehouse[]
  stockItems         StockItem[]
  posFloors          PosFloor[]
  posTables          PosTable[]
  posOrders          PosOrder[]
  posPayments        PosPayment[]
  invoices           Invoice[]
  inventoryMovements InventoryMovement[]
  paymentConnections PaymentConnection[]
  posCashSessions    PosCashSession[]

  // Revel POS-like relations
  timeClockEntries   TimeClockEntry[]
  customers          Customer[]
  loyaltyProgram     LoyaltyProgram?
  discounts          Discount[]
  modifierGroups     ModifierGroup[]
  taxRates           TaxRate[]
  tips               Tip[]
  voidRefunds        VoidRefund[]
  gratuitySetting    GratuitySetting?
  shiftSummaries     ShiftSummary[]
  prepTimeLogs       PrepTimeLog[]
  menuSchedules      MenuSchedule[]

  @@index([slug])
  @@index([ownerEmail])
  @@index([industry])
  @@index([createdAt])
}

enum CompanySize {
  S1_5
  S6_20
  S21_50
  S51_200
  S201_1000
  S1000_PLUS
}

enum TenantIndustry {
  RESTAURANT
  CAFE
  BAKERY
  RETAIL
  OTHER
}

enum PosTheme {
  EMERALD
  MIDNIGHT
  OCEAN
  SUNSET
  NEON
  ROYAL
}

model TenantUser {
  id        String         @id @default(cuid())
  tenantId  String
  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email     String
  firstName String
  lastName  String
  phone     String?
  passwordHash String?
  role      TenantUserRole @default(OWNER)
  isActive  Boolean        @default(true)
  lastLoginAt DateTime?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  posSessions PosSession[]
  openedPosOrders PosOrder[] @relation("PosOrderOpenedBy")
  openedCashSessions PosCashSession[] @relation("CashSessionOpenedBy")
  closedCashSessions PosCashSession[] @relation("CashSessionClosedBy")

  // Revel POS-like relations
  timeClockEntries TimeClockEntry[]
  tips             Tip[] @relation("EmployeeTips")
  voidsApproved    VoidRefund[] @relation("VoidApprovedBy")
  voidsCreated     VoidRefund[] @relation("VoidCreatedBy")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
}

enum TenantUserRole {
  OWNER
  ADMIN
  MANAGER
  STAFF
  KITCHEN
}

model Product {
  id         String     @id @default(cuid())
  tenantId   String
  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  name       String
  sku        String?
  priceCents Int        @default(0)
  currency   String     @default("AED")
  isActive   Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  stockItems                 StockItem[]
  invoiceLines               InvoiceLine[]
  inventoryMovementLineItems InventoryMovementLine[]
  posOrderItems              PosOrderItem[]
  modifierGroups             ProductModifierGroup[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([categoryId])
  @@index([isActive])
}

model ProductCategory {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products  Product[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([sortOrder])
}

model PosFloor {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tables    PosTable[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([sortOrder])
}

model PosTable {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  floorId   String
  floor     PosFloor @relation(fields: [floorId], references: [id], onDelete: Cascade)
  name      String
  capacity  Int      @default(4)
  x         Float    @default(0)
  y         Float    @default(0)
  width     Float    @default(140)
  height    Float    @default(110)
  shape     PosTableShape @default(RECT)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    PosOrder[]

  @@unique([tenantId, floorId, name])
  @@index([tenantId])
  @@index([floorId])
  @@index([isActive])
}

enum PosTableShape {
  RECT
  ROUND
}

model PosOrder {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tableId   String?
  table     PosTable? @relation(fields: [tableId], references: [id], onDelete: SetNull)
  openedById String?
  openedBy  TenantUser? @relation("PosOrderOpenedBy", fields: [openedById], references: [id], onDelete: SetNull)
  customerId String?
  customer  Customer? @relation("CustomerOrders", fields: [customerId], references: [id], onDelete: SetNull)
  status    PosOrderStatus @default(OPEN)
  orderNumber String
  notes     String?  @db.Text
  subtotalCents Int  @default(0)
  discountCents Int  @default(0)
  taxCents  Int      @default(0)
  totalCents Int     @default(0)
  tipCents  Int      @default(0)
  currency  String   @default("AED")
  openedAt  DateTime @default(now())
  sentToKitchenAt DateTime?
  closedAt  DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     PosOrderItem[]
  payments  PosPayment[]
  appliedDiscounts AppliedDiscount[]
  tips      Tip[]
  voidRefunds VoidRefund[]
  prepTimeLogs PrepTimeLog[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([status])
  @@index([tableId])
  @@index([openedAt])
}

enum PosOrderStatus {
  OPEN
  IN_KITCHEN
  READY
  FOR_PAYMENT
  PAID
  CANCELLED
}

model PosOrderItem {
  id             String   @id @default(cuid())
  orderId        String
  order          PosOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId      String?
  product        Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  productName    String
  unitPriceCents Int      @default(0)
  quantity       Int      @default(1)
  discountPercent Float?  @default(0)
  notes          String?  @db.Text
  status         PosOrderItemStatus @default(NEW)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  modifiers      OrderItemModifier[]

  @@index([orderId])
  @@index([productId])
  @@index([status])
}

enum PosOrderItemStatus {
  NEW
  SENT
  IN_PROGRESS
  READY
  SERVED
  VOID
}

model PosPayment {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderId     String
  order       PosOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  provider    PosPaymentProvider
  status      PosPaymentStatus @default(PENDING)
  amountCents Int
  currency    String   @default("AED")
  processorRef String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([orderId])
  @@index([status])
}

enum PosPaymentProvider {
  CASH
  BANK
  PAYPAL
  CARD
}

enum PosPaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  CANCELLED
  REFUNDED
}

model PosSession {
  id           String   @id @default(cuid())
  token        String   @unique
  tenantUserId String
  tenantUser   TenantUser @relation(fields: [tenantUserId], references: [id], onDelete: Cascade)
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  ipAddress    String?
  userAgent    String?

  @@index([tenantUserId])
  @@index([token])
}

// Cash Register Session (Opening/Closing Control)
model PosCashSession {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  openedById      String
  openedBy        TenantUser @relation("CashSessionOpenedBy", fields: [openedById], references: [id], onDelete: Cascade)
  closedById      String?
  closedBy        TenantUser? @relation("CashSessionClosedBy", fields: [closedById], references: [id], onDelete: SetNull)
  status          PosCashSessionStatus @default(OPEN)
  openingCashCents Int     @default(0)
  closingCashCents Int?
  expectedCashCents Int?
  cashDifferenceCents Int?
  currency        String   @default("AED")
  notes           String?  @db.Text
  closingNotes    String?  @db.Text
  openedAt        DateTime @default(now())
  closedAt        DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  shiftSummary    ShiftSummary?

  @@index([tenantId])
  @@index([openedById])
  @@index([status])
  @@index([openedAt])
}

enum PosCashSessionStatus {
  OPEN
  CLOSED
}

model Warehouse {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  code      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stockItems         StockItem[]
  inventoryMovements InventoryMovement[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model StockItem {
  id           String    @id @default(cuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouseId  String
  warehouse    Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  productId    String
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  onHand       Int       @default(0)
  reserved     Int       @default(0)
  reorderPoint Int       @default(0)
  updatedAt    DateTime  @updatedAt

  @@unique([warehouseId, productId])
  @@index([tenantId])
  @@index([productId])
}

model Invoice {
  id           String        @id @default(cuid())
  tenantId     String
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  number       String
  status       InvoiceStatus @default(DRAFT)
  customerName String
  customerEmail String?
  issuedAt     DateTime      @default(now())
  dueAt        DateTime?
  subtotalCents Int          @default(0)
  taxCents     Int           @default(0)
  totalCents   Int           @default(0)
  currency     String        @default("AED")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  lines        InvoiceLine[]

  @@unique([tenantId, number])
  @@index([tenantId])
  @@index([status])
  @@index([issuedAt])
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  VOID
  OVERDUE
}

model InvoiceLine {
  id            String   @id @default(cuid())
  invoiceId     String
  invoice       Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  productId     String?
  product       Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  description   String
  quantity      Int      @default(1)
  unitPriceCents Int     @default(0)
  lineTotalCents Int     @default(0)

  @@index([invoiceId])
}

model InventoryMovement {
  id          String                 @id @default(cuid())
  tenantId    String
  tenant      Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouseId String
  warehouse   Warehouse              @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  type        InventoryMovementType
  status      InventoryMovementStatus @default(DRAFT)
  reference   String
  notes       String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  lines       InventoryMovementLine[]

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

enum InventoryMovementType {
  RECEIPT
  DELIVERY
  ADJUSTMENT
  TRANSFER
}

enum InventoryMovementStatus {
  DRAFT
  POSTED
  CANCELLED
}

model InventoryMovementLine {
  id         String            @id @default(cuid())
  movementId String
  movement   InventoryMovement @relation(fields: [movementId], references: [id], onDelete: Cascade)
  productId  String
  product    Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity   Int

  @@index([movementId])
  @@index([productId])
}

model PaymentConnection {
  id             String                   @id @default(cuid())
  tenantId       String
  tenant         Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  provider       PaymentProvider
  status         PaymentConnectionStatus  @default(DISCONNECTED)
  displayName    String
  lastConnectedAt DateTime?
  metadata       Json?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt

  @@unique([tenantId, provider])
  @@index([tenantId])
  @@index([status])
}

enum PaymentProvider {
  BANK
  PAYPAL
  CARD
}

enum PaymentConnectionStatus {
  DISCONNECTED
  PENDING
  CONNECTED
}

// ==========================================
// REVEL POS-LIKE FEATURES
// ==========================================

// Employee Time Clock
model TimeClockEntry {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employeeId   String
  employee     TenantUser @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  clockInAt    DateTime
  clockOutAt   DateTime?
  breakMinutes Int      @default(0)
  notes        String?
  status       TimeClockStatus @default(CLOCKED_IN)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeId])
  @@index([clockInAt])
  @@index([status])
}

enum TimeClockStatus {
  CLOCKED_IN
  ON_BREAK
  CLOCKED_OUT
}

// Customer CRM
model Customer {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  firstName    String
  lastName     String
  email        String?
  phone        String?
  dateOfBirth  DateTime?
  notes        String?  @db.Text
  tags         String[] @default([])
  loyaltyPoints Int     @default(0)
  totalSpentCents Int   @default(0)
  visitCount   Int      @default(0)
  lastVisitAt  DateTime?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  loyaltyTransactions LoyaltyTransaction[]
  orders              PosOrder[] @relation("CustomerOrders")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([phone])
  @@index([loyaltyPoints])
}

// Loyalty Program
model LoyaltyProgram {
  id               String   @id @default(cuid())
  tenantId         String   @unique
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name             String   @default("Loyalty Program")
  pointsPerDollar  Int      @default(1)
  pointsToRedeem   Int      @default(100)
  redeemValue      Int      @default(100)  // In cents
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tiers            LoyaltyTier[]
}

model LoyaltyTier {
  id              String   @id @default(cuid())
  programId       String
  program         LoyaltyProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  name            String
  minPoints       Int
  multiplier      Float    @default(1.0)
  benefits        String?  @db.Text
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())

  @@index([programId])
  @@index([minPoints])
}

model LoyaltyTransaction {
  id           String   @id @default(cuid())
  customerId   String
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  type         LoyaltyTransactionType
  points       Int
  orderId      String?
  description  String?
  createdAt    DateTime @default(now())

  @@index([customerId])
  @@index([type])
  @@index([createdAt])
}

enum LoyaltyTransactionType {
  EARN
  REDEEM
  ADJUST
  EXPIRE
  BONUS
}

// Discounts & Promotions
model Discount {
  id             String   @id @default(cuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name           String
  code           String?
  type           DiscountType
  value          Int      // Cents for FIXED, basis points for PERCENTAGE (e.g., 1000 = 10%)
  minOrderCents  Int?     // Minimum order value
  maxUsageCount  Int?     // Max times this can be used
  usageCount     Int      @default(0)
  applicableTo   DiscountApplicableTo @default(ORDER)
  categoryIds    String[] @default([])
  productIds     String[] @default([])
  startDate      DateTime?
  endDate        DateTime?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  appliedDiscounts AppliedDiscount[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@index([isActive])
}

enum DiscountType {
  PERCENTAGE
  FIXED
  BOGO       // Buy One Get One
}

enum DiscountApplicableTo {
  ORDER
  CATEGORY
  PRODUCT
}

model AppliedDiscount {
  id           String   @id @default(cuid())
  orderId      String
  order        PosOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  discountId   String?
  discount     Discount? @relation(fields: [discountId], references: [id], onDelete: SetNull)
  name         String
  type         DiscountType
  value        Int
  amountCents  Int      // Actual discount amount applied
  createdAt    DateTime @default(now())

  @@index([orderId])
  @@index([discountId])
}

// Product Modifiers (Add-ons, Variants)
model ModifierGroup {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  minSelections Int     @default(0)
  maxSelections Int     @default(1)
  isRequired   Boolean  @default(false)
  sortOrder    Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  modifiers    Modifier[]
  productLinks ProductModifierGroup[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model Modifier {
  id           String   @id @default(cuid())
  groupId      String
  group        ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  name         String
  priceCents   Int      @default(0)
  isDefault    Boolean  @default(false)
  sortOrder    Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orderItemModifiers OrderItemModifier[]

  @@index([groupId])
}

model ProductModifierGroup {
  id              String   @id @default(cuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  modifierGroupId String
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  sortOrder       Int      @default(0)

  @@unique([productId, modifierGroupId])
  @@index([productId])
  @@index([modifierGroupId])
}

model OrderItemModifier {
  id           String   @id @default(cuid())
  orderItemId  String
  orderItem    PosOrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifierId   String?
  modifier     Modifier? @relation(fields: [modifierId], references: [id], onDelete: SetNull)
  name         String
  priceCents   Int      @default(0)
  quantity     Int      @default(1)

  @@index([orderItemId])
  @@index([modifierId])
}

// Tax Configuration
model TaxRate {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  rate         Int      // Basis points (e.g., 500 = 5%)
  isDefault    Boolean  @default(false)
  isInclusive  Boolean  @default(false) // Tax included in price
  appliesTo    TaxAppliesTo @default(ALL)
  categoryIds  String[] @default([])
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isDefault])
}

enum TaxAppliesTo {
  ALL
  CATEGORIES
  DINE_IN
  TAKEOUT
}

// Tips Management
model Tip {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderId      String
  order        PosOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  employeeId   String?
  employee     TenantUser? @relation("EmployeeTips", fields: [employeeId], references: [id], onDelete: SetNull)
  amountCents  Int
  paymentId    String?
  createdAt    DateTime @default(now())

  @@index([tenantId])
  @@index([orderId])
  @@index([employeeId])
  @@index([createdAt])
}

// Void/Refund Tracking
model VoidRefund {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderId      String
  order        PosOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  type         VoidRefundType
  reason       String
  amountCents  Int
  approvedById String?
  approvedBy   TenantUser? @relation("VoidApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  createdById  String
  createdBy    TenantUser @relation("VoidCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())

  @@index([tenantId])
  @@index([orderId])
  @@index([type])
  @@index([createdAt])
}

enum VoidRefundType {
  VOID
  REFUND
  ITEM_VOID
  PARTIAL_REFUND
}

// Auto-Gratuity Settings
model GratuitySetting {
  id             String   @id @default(cuid())
  tenantId       String   @unique
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  minPartySize   Int      @default(6)
  gratuityRate   Int      @default(1800) // Basis points (e.g., 1800 = 18%)
  isActive       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// Shift Summary
model ShiftSummary {
  id                String   @id @default(cuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  cashSessionId     String
  cashSession       PosCashSession @relation(fields: [cashSessionId], references: [id], onDelete: Cascade)
  totalSalesCents   Int      @default(0)
  totalTaxCents     Int      @default(0)
  totalDiscountsCents Int    @default(0)
  totalRefundsCents Int      @default(0)
  totalTipsCents    Int      @default(0)
  cashPaymentsCents Int      @default(0)
  cardPaymentsCents Int      @default(0)
  otherPaymentsCents Int     @default(0)
  orderCount        Int      @default(0)
  itemCount         Int      @default(0)
  voidCount         Int      @default(0)
  averageOrderCents Int      @default(0)
  createdAt         DateTime @default(now())

  @@unique([cashSessionId])
  @@index([tenantId])
  @@index([createdAt])
}

// Kitchen Prep Time Tracking
model PrepTimeLog {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderId      String
  order        PosOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sentAt       DateTime
  startedAt    DateTime?
  completedAt  DateTime?
  prepTimeSeconds Int?
  itemCount    Int      @default(1)
  createdAt    DateTime @default(now())

  @@index([tenantId])
  @@index([orderId])
  @@index([sentAt])
}

// Menu Schedule (Happy Hour, etc.)
model MenuSchedule {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  startTime    String   // HH:MM format
  endTime      String   // HH:MM format
  daysOfWeek   Int[]    // 0 = Sunday, 6 = Saturday
  priceAdjustment Int   @default(0) // Basis points (negative for discount)
  categoryIds  String[] @default([])
  productIds   String[] @default([])
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tenantId])
  @@index([isActive])
}
